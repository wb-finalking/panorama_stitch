# 全景图片拼接

---

​	为了获得传统的超广角和高分辨率图像方法需要使用昂贵的专用相机设备来拍摄和处理图像。但近年来随着数码相机，智能手机等的普及，经济的手持式成像设备可以方便人们获得离散图像顺序为一些场景，然后通过适当的图像处理提高图像质量的方法，最终实现图像的自动化拼接。

​	本文参照MSR提供的图像拼接教程实现了单照相机提供的一组图像的自动拼接，依据openCV提供的函数库提取图像的ORB特征，利用LSH（Local-Sensitive Hashing）构建图像特征索引寻找最近邻来得到两张图像之间特征点的匹配结果，依据匹配结果判断两张图像是否相邻来构建一组图像的邻接矩阵，通过寻找邻接矩阵的连通域来将输入的一组图像按场景分成不同组，之后使用RANSAC（随机抽样一致性）来筛选两组图像的匹配特征点，之后通过函数库求解旋转矩阵H旋转图像，然后使用拉普拉斯金字塔将图片融合拼接。

**关键子：**ORB，LSH，邻接矩阵，RANSAC，拉普拉斯金字塔

---

## 1引言

​	要得到宽视野的图像一般需要专业的摄像机设备来拍摄，但不是所有人都能承担的起昂贵的设备。随着智能手机的普及，拍摄短小高分辨率的图像已经成为可能，可以使用两幅或多幅图像的图像拼接来生成宽视场图像或视频，并且所生成的宽图像或视频可以有效地应用于各种应用，例如视频监控，虚拟现实，遥感，军事防御以及多视图广播。

## 2相关工作

​	图像拼接的应用程序分为三类：（1）拼接一台设备拍摄的连续图像，（2）拼接来自多台设备的图像，（3）拼接使用多台设备拍摄的视频。 通常用一个设备拍摄的连续图像，使用视图方向，位置信息和简单特征匹配可以容易地生成全景图像。为了对齐多视图图像，最近已经使用了基于特征点匹配的方法，相应的特征点可以在不同的尺度上观察到，因此尺度不变特征变换（SIFT）已经被广泛的使用。SIFT可以提取对于旋转，尺度和亮度方差不变的特征，其中使用了具有不同$\sigma$值的高斯函数。 加速的强大功能（SURF）是一种替代特征检测器。 它使用Haar小波响应，比SIFT快几倍。为了找到一副图像在另一幅图像中的匹配特征点，许多拼接方法使用近似最近邻居的快速库（FLANN），这比其他邻近搜索要快。为了估计全局单应性矩阵（HM），随机样本一致（RANSAC）是一种去除异常值的参数估计方法。

## 3方法实现

​	本文参照MSR提供的图像拼接教程[^1]实现了单相机得到的一组图像做拼接，并基于QT做成了软件，其中使用了ORB特征提取、LSH最近邻搜索、邻接矩阵求解连通域、RANSAC等方法。

### 3.1特征的提取与图像匹配

​	本文使用OpenCV提供的函数库对每个图像做ORB特征点检测并计算特征描述矩阵M。两幅图像的特征点匹配，需要对其中一副图像的特征描述矩阵建立LSH索引，然后使用汉明距离对另一副图像的每一个特征点寻找2个最近邻并计算出距离D1和D2，通过判断D1<0.4*D2是否成立来决定最小距离的特征点是否与此特征点匹配，最后找到两幅图像的所有特征点匹配对。对所有图像两两计算彼此之间的特征点匹配对，通过特征点匹配对的数目判断两幅图像是否是相邻的场景，以此建立图像的邻接矩阵。通过寻找邻接矩阵的连通域使得原始的额一组图像按场景分成不同组做全景拼接。

### 3.2图像拼接

​	得到相邻的两张图像后，需要计算图像的单应性变换矩阵HM，通过此矩阵将图像进行变换才能与另一副图像作拼接。

​	然而两幅图像的HM不能直接通过所有匹配点的位置坐标做拟合计算，需要使用RANSAC随机采样一致性来筛选一些点对。

​	RANSAC算法首先需要通过一些参数，来计算固定的迭代次数k：$k=\frac{\log(1-p)}{\log(1-w^n)}$

​	其中p表示迭代过程中从数据集内随机选取出的点均为局内点的概率，w表示每次从数据集中选取一个局内点的概率，n表示每次抽样的个数。

​	然后通过迭代将抽取的4个匹配对计算得到一个HM，用此HM计算每一个特征点变换后的误差距离，通过提前定义好的误差阈值剔除一些匹配对。k次迭代完后取获得匹配对个数最多的一组匹配对做最后的HM拟合计算得到最终的HM，然后将一组图像做拼接。

### 3.3图像融合

​	简单的图像拼接会使得在拼接出有明显的接缝，所以还需要对拼接的时候做平滑处理。本文采用拉普拉斯金字塔的方法对图像做平滑处理。首先对两幅图像通过OpenCV缩放函数进行缩小，得到一组不同比例的图像构成图像金字塔，然后将每一层图像与上一层图像做差来更新此层图像，最后得到拉普拉斯金字塔。将每一层的图像与另一个金字塔相应的层图像做拼接得到拼接后的图像金字塔。将金字塔从高到低相加得到最后的拼接结果。

## 4结论

​	本文通过简单地实现图像拼接发现并不能得到很好的结果，因为简单地拼接会使得最后地拼接结果场景中地物体出现与实物不一致地现象，比如扭曲等。所以高质量地图像拼接还需要我们做进一步的研究。

## 参考文献

[^1]: Richard Szeliski. Last updated. 2006. Image Alignment and Stitching:A Tutorial. Technical Report:MSR-TR-2004-92









